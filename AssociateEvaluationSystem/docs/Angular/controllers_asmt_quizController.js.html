<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/asmt/quizController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/asmt/quizController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @class AES.asmtApp.quizController
 */

asmt.controller("quizController", function($scope, $rootScope, $http, $location, $window, $timeout, $anchorScroll) {
	$rootScope.states = [];
	$scope.answers = [];
	$scope.numEditors = 0;
	$scope.oneAtATime = false;
	$scope.editors = [];
	$rootScope.protoTest;
	$scope.questions = [];
	$rootScope.snippetStarters = [];
	$rootScope.snippetSubmissions = [];
	$rootScope.snippetStartersInd = [];
	$scope.protoTest2 = {};
	$scope.testtaker = "loading...";
	$scope.submitted = false;
    $scope.modalShown = false;

	getQuizQuestions();
	// declare review settings
	$rootScope.reviewBool = false;

    //RICHARD: get global settings to see if user can review
    var settingsUrl = "/aes/admin/globalSettings"
    $scope.getSettings = function(){
        $scope.getSettingsUnsuccessful = false;
        $http({
            method  : 'GET',
            url		: settingsUrl
        }).success(function(data){
            if (!data){
                $scope.getSettingsUnsuccessful = true;
            } else {
                $scope.settings = {};
                $scope.settings.keys = [];
                data.forEach(function (s){
                    $scope.settings[s.propertyId] = s;
                    $scope.settings.keys.push(s.propertyId);
                });
            }
        }).error( function() {
            $scope.getSettingsUnsuccessful = true;
        });
    }
    $scope.getSettings();

	var makeState = function(input) {
		var temp = {
			id: input,
			flagged: false,
			saved: false,
			open: true
		};
		$scope.states.push(temp);
	};
	var makeAnswers = function(ndx) {
		if ($scope.questions[ndx].question.format.formatName === "Multiple Choice" ) {
			$scope.answers.push([-1]);
		}
		else {
			$scope.answers.push(-1);
		}
	}
	var initSetup = function() {
		/*SA-CHANGES STARTED*/
		for (var i = 0; i &lt; $scope.questions.length; i++) {
			var boolT = 0; var optionS=[];
			for (var z3=0; z3 &lt; $rootScope.protoTest.options.length; z3++)
			{
					for(var k=0;k&lt;$scope.questions[i].question.option.length;k++){
					if($scope.questions[i].question.option[k].optionId==$scope.protoTest.options[z3].optionId)
						{
						  boolT=1;
						  optionS.push(k);
						}
				}
			}
			
			if($scope.questions[i].question.format.formatName === "Drag and Drop") {
			 var oDragDrop=[];
			 for(var z4=0;z4&lt;$rootScope.protoTest.assessmentDragDrop.length;z4++){
					var uOrder = $rootScope.protoTest.assessmentDragDrop[z4].userOrder;
					var dDrop = $rootScope.protoTest.assessmentDragDrop[z4].dragDrop;
					
					if(($scope.questions[i].question.dragdrop).indexOf(dDrop)){
						oDragDrop[uOrder-1]=dDrop;
					}
			 }
			 if(oDragDrop.length){
				 $scope.questions[i].question.dragdrop = oDragDrop;
				 boolT=1
			 }
			}
			
			makeState(i);
			if(boolT==1){
				
				if ($scope.questions[i].question.format.formatName === "Multiple Choice" ) {
					if(optionS.length){
						$scope.selectOption(optionS[0],i);
					}
				}
				else if($scope.questions[i].question.format.formatName === "Multiple Select")
				{
					for(var l=0;l&lt;optionS.length;l++){
						$scope.selectOption(optionS[l],i);
					}
				}
				
				$scope.states[i].saved = true;
				
			}else{
			 makeAnswers(i);
			}
			/*SA-CHANGES ENDED*/
		}
		$scope.testtaker = $rootScope.protoTest.user.firstName + " " + $rootScope.protoTest.user.lastName;
		
		$timeout(function () {
			for (var i=0; i &lt; $scope.filteredQuestions.length; i++)
			{
				if ($scope.filteredQuestions[i].question.format.formatName === "Code Snippet")
				{
					var editorId = "editor"+$scope.filteredQuestions[i].question.questionId;
					var aceEditor = ace.edit(editorId);
					for(var z=0;z&lt;$rootScope.snippetStartersInd.length;z++){
						if($rootScope.snippetStartersInd[z]==$scope.filteredQuestions[i].question.questionId){
							aceEditor.getSession().setValue($rootScope.snippetStarters[z], -1);
						}
					}
				}
			}
		}, 5000);
	
		
	};

	$scope.collapseQuestion = function(index) {
		$scope.states[index].open = !$scope.states[index].open;
	};
	
	var saveQuestion = function(index) {

		var q = $scope.questions[index];
		
		if(q.question.format.formatName === "Drag and Drop") {
			for (var i = 0; i &lt; q.question.dragdrop.length; i++) {
				var assessmentDragDrop = {
						assessmentDragDropId : 0,
						userOrder : i+1,
						assessmentId : $scope.protoTest.assessmentId,
						dragDrop : q.question.dragdrop[i]
				};
				$rootScope.protoTest.assessmentDragDrop.push(assessmentDragDrop);
			}
		}
		
		$scope.states[index].saved = true;
	};

	$scope.handleSaveClick = function(index) {
		//If question is not already saved, save it
		saveQuestion(index);
		
		$rootScope.protoTest.assessmentDragDrop.forEach(function(entry){
			delete entry.assessmentId;
			entry.assessment = {"assessmentId" : $rootScope.protoTest.assessmentId,};
		});

		var answerData = {
				assessment : $rootScope.protoTest,
				snippetUploads : $rootScope.snippetSubmissions
		};

		$http({
			method: 'POST',
			url: "aes/rest/quickSaveAssessment",
			headers: {'Content-Type': 'application/json'},
			data: answerData
		}).then(function(response) {
			//Removed console logs for sonar cube.
		});
	}

	$scope.flagQuestion = function(index) {
		$scope.states[index].flagged = !$scope.states[index].flagged;
	};
	
	$scope.selectOption = function (ndxOption, ndxQuestion) {
		// Handles putting the answer into the javascript object when the uesr
		// selects an option
		var answer;
		
		if($scope.questions[ndxQuestion].question.format.formatName === "Multiple Choice") {
			// Handles multiple choice questions
			$scope.answers[ndxQuestion] = ndxOption;
			answer = $scope.questions[ndxQuestion].question.option[ndxOption]; // Store selected answer
			
			var questionOptionIdArray = []; // Get options from question
			
			// Gets options from current selecting question into an array.
			for (var z=0; z &lt; $scope.questions[ndxQuestion].question.option.length; z++)
			{
				questionOptionIdArray.push($scope.questions[ndxQuestion].question.option[z].optionId);
			}
			
			// Checks the answer selection array for previous multiple choice selections and deletes
			// them from the array since we only want ONE radial selection kept in the answer array
			for (var z2=0; z2 &lt; questionOptionIdArray.length; z2++)
			{
				for (var z3=0; z3 &lt; $rootScope.protoTest.options.length; z3++)
				{
					if ($rootScope.protoTest.options[z3].optionId === questionOptionIdArray[z2])
					{
						// Remove previously selected multiple choices from same question
						$rootScope.protoTest.options.splice(z3,1);
					}
				}
			}
			
			// Finally, add current selected multiple choice option to the answers array
			$rootScope.protoTest.options.push(answer);
			
		}else if ($scope.questions[ndxQuestion].question.format.formatName === "Multiple Select" ) {
			// Handles multiple select questions
			answer = $scope.questions[ndxQuestion].question.option[ndxOption];
			var foundAt = $rootScope.protoTest.options.indexOf(answer);
			
			if (foundAt === -1) {
				// User has not selected this previously, add it
				$rootScope.protoTest.options.push(answer);
			} else {
				// User has selected this previously, delete it.
				$rootScope.protoTest.options.splice(foundAt, 1);
			}
		}
		
		if ($scope.states[ndxQuestion].saved) {
			$scope.states[ndxQuestion].saved = false;
		}
	}
	
	$scope.checkChecked = function (ndxOption, ndxQuestion) {
		var output = false;
		
		if($scope.questions[ndxQuestion].question.format.formatName === "Multiple Choice") {
			// Handle multiple choice
			if ($scope.answers[ndxQuestion] === ndxOption) {
				output = true;
			}
		} else if ($scope.questions[ndxQuestion].question.format.formatName === "Multiple Select") {
			// Handle multiple select
			var answer = $scope.questions[ndxQuestion].question.option[ndxOption];
			var foundAt = $rootScope.protoTest.options.indexOf(answer);
			if (foundAt === -1){
				// This answer has not been previously selected
				output = false;
			} else {
				// This answer has been previously selected, should be marked
				output = true;
			}
		}
		return output;
	}
	
	// EDITORS	
	$scope.getType = function(filetype) {
		var output;
		switch(filetype) {
		case "java" :
			output = "java";
			break;
		case "cpp" :
        case "c++" :
        case "c" :
			output = "c_cpp";
			break;
		case "cs" :
			output = "csharp";
			break;
		default : 
			output = "java";
			break;
		}
		return output;
	}
	
	$scope.aceChanged = function(e) {
		var id2 = e[1].container.id;
		var editor = e[1];
		var SnippetUpload = function(_code, _questionId, _fileType){
			this.code = _code;
			this.questionId = _questionId;
			this.fileType = _fileType;
		};
		var snippetQuestionIndex;
		var q = {};
		for (var i = 0; i &lt; $scope.questions.length; i++ ) {
			if ($scope.questions[i].question.questionId == id2.substr(6, id2.length)){
				q = $scope.questions[i];
				snippetQuestionIndex = i;
			}
		}
		
		var incFileType = q.question.snippetTemplates[0].fileType;
		var newSnippet = new SnippetUpload(editor.getValue(), id2.substr(6, id2.length), incFileType);
		
		for (i = 0; i &lt; $rootScope.snippetSubmissions.length; i++){

			if ($rootScope.snippetSubmissions[i].questionId == newSnippet.questionId){

				$rootScope.snippetSubmissions.splice(i, 1);
			}
		}
		$rootScope.snippetSubmissions.push(newSnippet);		
		saveQuestion(snippetQuestionIndex);
	};

	// PAGINATION
 	$scope.filteredQuestions = [];
	$scope.currentPage = 1;
	$scope.numPerPage = 5;
	$scope.maxSize = 100;
	
	//pagination goes to top of the page
	$scope.pageChanged = function() {
	    $location.hash('top');
	    $anchorScroll();
	};
	
	//code to jump to page and question 
	$scope.jumpPage = function (index) {
		$scope.pageChanged();
		var numPage=index/$scope.numPerPage;
		$scope.currentPage =1+ Math.floor(numPage);	
		
		
		
		$timeout(function () {
			$location.hash('anchor' + index);

		     
		     $anchorScroll();
			
	    }, 50);
		
	  
	    
	      
		
	};

	$scope.$watch('currentPage + numPerPage', function() {
		var begin = (($scope.currentPage - 1) * $scope.numPerPage), end = begin
				+ $scope.numPerPage;

		$scope.filteredQuestions = $scope.questions.slice(begin, end);

		$timeout(function () {
			//var snipCount = 0;
			for (var i=0; i &lt; $scope.filteredQuestions.length; i++)
			{
				if ($scope.filteredQuestions[i].question.format.formatName === "Code Snippet")
				{
					var editorId = "editor"+$scope.filteredQuestions[i].question.questionId;
					var aceEditor = ace.edit(editorId);
					//To init ace editor if other than first page
					if(aceEditor.getSession().getValue()==="Enter code here"){
						for(z=0;z&lt;$rootScope.snippetStartersInd.length;z++){
							if($rootScope.snippetStartersInd[z]==$scope.filteredQuestions[i].question.questionId){
								aceEditor.getSession().setValue($rootScope.snippetStarters[z], -1);
								break;

							}
						}
					}

					//To keep changes on the ace editor if pages are switched
					for(z=0;z&lt;$rootScope.snippetSubmissions.length;z++){
						if($rootScope.snippetSubmissions[z].questionId==$scope.filteredQuestions[i].question.questionId){
							aceEditor.getSession().setValue($rootScope.snippetSubmissions[z].code, -1);
						}
					}

				}
			}
	    }, 2000);
		
	});
	
	$scope.$watch('questions', function() {
		var begin = (($scope.currentPage - 1) * $scope.numPerPage), end = begin
				+ $scope.numPerPage;

		$scope.filteredQuestions = $scope.questions.slice(begin, end);
	});
	
	// AJAX
	function getQuizQuestions() {
		
		$http({
			method: 'GET',
			url: QUIZ_REST_URL + $location.search().asmt,
			headers: {'Content-Type': 'application/json'}
		})
		.then(function(response) {
			console.log(response);
			// Check response for assessment availability
			if (response.data.msg === "allow"){
				// Assessment ready to take
				$rootScope.protoTest = response.data.assessment;
				$scope.questions = $rootScope.protoTest.template.templateQuestion;
				$rootScope.snippetStarters = response.data.snippets;
				$rootScope.snippetStartersInd = response.data.snippetIndexes;
				initSetup();
				$rootScope.initQuizNav();
				$rootScope.initTimer(response.data.timeLimit, response.data.newTime);
				$rootScope.expireDate = response.data.expireDate;

				// In $rootScope, instantiate global settings, put response.data.globalSettings in there
				$rootScope.reviewBool = response.data.reviewBool;
				
			}else {
				// Assessment was taken or time expired, redirecting to expired page
				$window.location.href = '/aes/expired';
			}
		});
	}
	
	$rootScope.submitAssessment = function(){
		$rootScope.stopTimer();
		$scope.submitted = true;

		$rootScope.protoTest.assessmentDragDrop.forEach(function(entry){

			delete entry.assessmentId;
			entry.assessment = {"assessmentId" : $rootScope.protoTest.assessmentId,};
		});
		console.table($rootScope.snippetSubmissions);
		
		
		var answerData = {
				assessment : $rootScope.protoTest,
				snippetUploads : $rootScope.snippetSubmissions
		};

		$http({
			method: 'POST',
			url: "aes/rest/submitAssessment",
			headers: {'Content-Type': 'application/json'},
			data: answerData
		}).then(function(response) {
			//Removed console log for sonar cube.
			// Perform a check on global settings
			if ($scope.settings[1].propertyValue == "true"){
				//This should allow the questions to put into this page
				$window.location.href = '/aes/quizReview?asmt=' + $location.search().asmt;
			} else {
				$window.location.href = '/aes/goodbye';
			}
		});
	}

    //for question modal

    $scope.toggleModal = function() {
        $scope.modalShown = !$scope.modalShown;
    };
	
});

asmt.directive('modalDialog', function() {
    return {
        restrict: 'E',
        scope: {
            show: '='
        },
        replace: true, // Replace with the template below
        transclude: true, // we want to insert custom content inside the directive
        link: function(scope, element, attrs) {
            scope.dialogStyle = {};
            if (attrs.width)
                scope.dialogStyle.width = attrs.width;
            if (attrs.height)
                scope.dialogStyle.height = attrs.height;
            scope.hideModal = function() {
                scope.show = false;
            };
        },
        template: "&lt;div class='ng-modal' ng-show='show'>&lt;div class='ng-modal-overlay' ng-click='hideModal()'>&lt;/div> &lt;div class='ng-modal-dialog' ng-style='dialogStyle'> &lt;div class='ng-modal-close' ng-click='hideModal()'>X&lt;/div> &lt;div class='ng-modal-dialog-content' ng-transclude>&lt;/div> &lt;/div> &lt;/div>"
    };
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AES.adminApp.AdminDashboardCtrl.html">AdminDashboardCtrl</a></li><li><a href="AES.adminApp.ChooseAssessmentCtrl.html">ChooseAssessmentCtrl</a></li><li><a href="AES.adminApp.CreateAssessmentCtrl.html">CreateAssessmentCtrl</a></li><li><a href="AES.adminApp.EmployeeViewCtrl.html">EmployeeViewCtrl</a></li><li><a href="AES.adminApp.MenuCtrl.html">MenuCtrl</a></li><li><a href="AES.adminApp.parserCtrl.html">parserCtrl</a></li><li><a href="AES.adminApp.RegisterEmployeeCtrl.html">RegisterEmployeeCtrl</a></li><li><a href="AES.adminApp.SettingsViewCtrl.html">SettingsViewCtrl</a></li><li><a href="AES.adminApp.UpdateEmployeeCtrl.html">UpdateEmployeeCtrl</a></li><li><a href="AES.asmtApp.CountdownController.html">CountdownController</a></li><li><a href="AES.asmtApp.landingPageCtrl.html">landingPageCtrl</a></li><li><a href="AES.asmtApp.quizController.html">quizController</a></li><li><a href="AES.asmtApp.QuizNavController.html">QuizNavController</a></li><li><a href="AES.asmtApp.quizReviewController.html">quizReviewController</a></li><li><a href="AES.bankApp.CategoryCtrl.html">CategoryCtrl</a></li><li><a href="AES.bankApp.MasterCtrl.html">MasterCtrl</a></li><li><a href="AES.bankApp.MenuCtrl.html">MenuCtrl</a></li><li><a href="AES.bankApp.QuestionCtrl.html">QuestionCtrl</a></li><li><a href="AES.bankApp.TagCtrl.html">TagCtrl</a></li><li><a href="AES.userApp.CandidateCtrl.html">CandidateCtrl</a></li><li><a href="AES.userApp.LoginCtrl.html">LoginCtrl</a></li><li><a href="AES.userApp.menuCtrl.html">menuCtrl</a></li><li><a href="AES.userApp.recruiterDashboardCtrl.html">recruiterDashboardCtrl</a></li><li><a href="AES.userApp.UpdateEmployeeCtrl.html">UpdateEmployeeCtrl</a></li></ul><h3>Namespaces</h3><ul><li><a href="AES.adminApp.html">adminApp</a></li><li><a href="AES.asmtApp.html">asmtApp</a></li><li><a href="AES.bankApp.html">bankApp</a></li><li><a href="AES.userApp.html">userApp</a></li><li><a href="AES%250DCreated%2520by%2520Mehrab%2520on%25205_30_2017..html">AESCreated by Mehrab on 5/30/2017.</a></li><li><a href="attr.ngfAsBackground.html">ngfAsBackground</a></li><li><a href="attr.ngfBackground.html">ngfBackground</a></li><li><a href="attr.ngfCapture.html">ngfCapture</a></li><li><a href="attr.ngfChange.html">ngfChange</a></li><li><a href="attr.ngfKeep.html">ngfKeep</a></li><li><a href="attr.ngfModelOptions.html">ngfModelOptions</a></li><li><a href="attr.ngfMultiple.html">ngfMultiple</a></li><li><a href="attr.ngfNoObjectUrl.html">ngfNoObjectUrl</a></li><li><a href="attr.ngfSelect.html">ngfSelect</a></li><li><a href="attr.ngfSize.html">ngfSize</a></li><li><a href="attr.ngfSrc.html">ngfSrc</a></li><li><a href="attr.ngfThumbnail.html">ngfThumbnail</a></li><li><a href="attr.ngfValidate.html">ngfValidate</a></li><li><a href="attr.ngModel.html">ngModel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#$get">$get</a></li><li><a href="global.html#adjustTop">adjustTop</a></li><li><a href="global.html#calculatePosition">calculatePosition</a></li><li><a href="global.html#dragItem">dragItem</a></li><li><a href="global.html#eventObj">eventObj</a></li><li><a href="global.html#getRawNode">getRawNode</a></li><li><a href="global.html#height">height</a></li><li><a href="global.html#isScrollable">isScrollable</a></li><li><a href="global.html#isTouchInvalid">isTouchInvalid</a></li><li><a href="global.html#movePosition">movePosition</a></li><li><a href="global.html#noDrag">noDrag</a></li><li><a href="global.html#offset">offset</a></li><li><a href="global.html#offsetParent">offsetParent</a></li><li><a href="global.html#options">options</a></li><li><a href="global.html#parsePlacement">parsePlacement</a></li><li><a href="global.html#parseStyle">parseStyle</a></li><li><a href="global.html#position">position</a></li><li><a href="global.html#positionArrow">positionArrow</a></li><li><a href="global.html#positionElements">positionElements</a></li><li><a href="global.html#positionStarted">positionStarted</a></li><li><a href="global.html#scrollbarPadding">scrollbarPadding</a></li><li><a href="global.html#scrollbarWidth">scrollbarWidth</a></li><li><a href="global.html#scrollParent">scrollParent</a></li><li><a href="global.html#setTriggers">setTriggers</a></li><li><a href="global.html#viewportOffset">viewportOffset</a></li><li><a href="global.html#width">width</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue May 30 2017 10:36:13 GMT-0400 (DST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
